import 'package:flutter/foundation.dart';
import '../screens/ai_chat_screen.dart';

class AiChatProvider with ChangeNotifier {
  final List<ChatMessage> _messages = [];
  bool _isLoading = false;

  List<ChatMessage> get messages => _messages;
  bool get isLoading => _isLoading;

  // æ¨¡æ“¬AIå›æ‡‰çš„çŸ¥è­˜åº«
  final Map<String, String> _knowledgeBase = {
    'æ¨è–¦': '''
æˆ‘ä¾†ç‚ºä½ æ¨è–¦ä¸€äº›å„ªç§€çš„æ›¸ç±ï¼š

ğŸ“š **ç¨‹å¼è¨­è¨ˆé¡**
â€¢ ã€ŠClean Codeã€‹- ç¨‹å¼ç¢¼å“è³ªçš„ç¶“å…¸ä¹‹ä½œ
â€¢ ã€Šè¨­è¨ˆæ¨¡å¼ã€‹- è»Ÿé«”è¨­è¨ˆçš„å¿…è®€ç¶“å…¸
â€¢ ã€Šæ¼”ç®—æ³•å°è«–ã€‹- æ¼”ç®—æ³•å­¸ç¿’çš„æ¬Šå¨æ•™æ

ğŸ¨ **è¨­è¨ˆé¡**
â€¢ ã€Šè¨­è¨ˆå¿ƒç†å­¸ã€‹- äº†è§£ç”¨æˆ¶å¿ƒç†çš„è¨­è¨ˆæŒ‡å—
â€¢ ã€Šè‰²å½©è¨­è¨ˆå­¸ã€‹- è‰²å½©æ­é…çš„å°ˆæ¥­çŸ¥è­˜

ğŸ¤– **äººå·¥æ™ºæ…§é¡**
â€¢ ã€Šæ©Ÿå™¨å­¸ç¿’å¯¦æˆ°ã€‹- å¯¦ç”¨çš„MLå…¥é–€æ›¸ç±
â€¢ ã€Šæ·±åº¦å­¸ç¿’ã€‹- AIé ˜åŸŸçš„ç¶“å…¸æ•™æ

é€™äº›æ›¸ç±åœ¨æˆ‘å€‘çš„æ›¸åº—éƒ½æœ‰åº«å­˜ï¼Œä½ å¯ä»¥é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡è¨Šï¼
''',
    'æ›¸ç±': '''
æˆ‘å€‘æ›¸åº—æœ‰è±å¯Œçš„æ›¸ç±é¸æ“‡ï¼š

ğŸ“– **ç†±é–€åˆ†é¡**
â€¢ ç¨‹å¼è¨­è¨ˆèˆ‡è»Ÿé«”é–‹ç™¼
â€¢ è¨­è¨ˆèˆ‡è—è¡“
â€¢ äººå·¥æ™ºæ…§èˆ‡æ©Ÿå™¨å­¸ç¿’
â€¢ è³‡æ–™åº«èˆ‡ç¶²è·¯å®‰å…¨
â€¢ é›²ç«¯é‹ç®—èˆ‡å€å¡Šéˆ

ğŸ” **å¦‚ä½•æ‰¾åˆ°æƒ³è¦çš„æ›¸**
1. ä½¿ç”¨æœå°‹åŠŸèƒ½è¼¸å…¥é—œéµå­—
2. ç€è¦½é¦–é çš„æ¨è–¦åˆ†é¡
3. æŸ¥çœ‹æš¢éŠ·æ’è¡Œæ¦œ
4. é—œæ³¨æ–°æ›¸ä¸Šæ¶

éœ€è¦æˆ‘å¹«ä½ æ¨è–¦ç‰¹å®šé¡å‹çš„æ›¸ç±å—ï¼Ÿ
''',
    'åƒ¹æ ¼': '''
é—œæ–¼æ›¸ç±åƒ¹æ ¼ï¼š

ğŸ’° **åƒ¹æ ¼ç¯„åœ**
â€¢ æ–°æ›¸ï¼š\$200 - \$800
â€¢ äºŒæ‰‹æ›¸ï¼š\$100 - \$400
â€¢ ç‰¹åƒ¹æ›¸ç±ï¼š\$150 - \$500

ğŸ¯ **å„ªæƒ æ´»å‹•**
â€¢ æ–°æœƒå“¡é¦–æ¬¡è³¼æ›¸äº«8æŠ˜å„ªæƒ 
â€¢ æ»¿\$500å…é‹è²»
â€¢ å®šæœŸèˆ‰è¾¦ç‰¹åƒ¹æ´»å‹•

ğŸ’¡ **çœéŒ¢å°è²¼å£«**
1. é—œæ³¨ä»Šæ—¥ç‰¹æƒ å€
2. æŸ¥çœ‹äºŒæ‰‹æ›¸é¸é …
3. è¨»å†Šæœƒå“¡äº«å—å„ªæƒ 
4. é—œæ³¨æˆ‘å€‘çš„ä¿ƒéŠ·æ´»å‹•

éœ€è¦æˆ‘å¹«ä½ æ‰¾ç‰¹å®šåƒ¹æ ¼ç¯„åœçš„æ›¸ç±å—ï¼Ÿ
''',
    'é‹è²»': '''
é—œæ–¼é‹è²»èªªæ˜ï¼š

ğŸšš **é‹è²»æ¨™æº–**
â€¢ ä¸€èˆ¬é…é€ï¼š\$60
â€¢ å¿«é€Ÿé…é€ï¼š\$100
â€¢ è¶…å•†å–è²¨ï¼š\$30

ğŸ **å…é‹æ¢ä»¶**
â€¢ è³¼ç‰©æ»¿\$500å³å¯å…é‹è²»
â€¢ æœƒå“¡ç”Ÿæ—¥ç•¶æœˆå…é‹
â€¢ ç‰¹æ®Šæ´»å‹•æœŸé–“å…é‹

ğŸ“ **é…é€ç¯„åœ**
â€¢ å…¨å°æœ¬å³¶
â€¢ é›¢å³¶åœ°å€ï¼ˆé‹è²»å¦è¨ˆï¼‰
â€¢ æµ·å¤–é…é€ï¼ˆéœ€è¯ç¹«å®¢æœï¼‰

â° **é…é€æ™‚é–“**
â€¢ ä¸€èˆ¬é…é€ï¼š3-5å€‹å·¥ä½œå¤©
â€¢ å¿«é€Ÿé…é€ï¼š1-2å€‹å·¥ä½œå¤©
â€¢ è¶…å•†å–è²¨ï¼š2-3å€‹å·¥ä½œå¤©

æœ‰ä»»ä½•é…é€å•é¡Œéƒ½å¯ä»¥è©¢å•æˆ‘ï¼
''',
    'æœƒå“¡': '''
é—œæ–¼æœƒå“¡åˆ¶åº¦ï¼š

ğŸ‘¤ **æœƒå“¡ç¦åˆ©**
â€¢ æ–°æœƒå“¡é¦–æ¬¡è³¼æ›¸8æŠ˜å„ªæƒ 
â€¢ ç”Ÿæ—¥ç•¶æœˆå…é‹è²»
â€¢ å°ˆå±¬æœƒå“¡åƒ¹æ ¼
â€¢ å„ªå…ˆç²å¾—æ–°æ›¸è³‡è¨Š
â€¢ ç©åˆ†å›é¥‹åˆ¶åº¦

ğŸ“ **è¨»å†Šæ–¹å¼**
1. é»æ“Šé¦–é çš„ã€Œè¨»å†Šã€æŒ‰éˆ•
2. å¡«å¯«åŸºæœ¬è³‡æ–™
3. é©—è­‰é›»å­éƒµä»¶
4. ç«‹å³äº«å—æœƒå“¡å„ªæƒ 

ğŸ¯ **ç©åˆ†åˆ¶åº¦**
â€¢ æ¯æ¶ˆè²»\$100ç²å¾—1ç©åˆ†
â€¢ 100ç©åˆ†å¯æŠ˜æŠµ\$10
â€¢ ç©åˆ†æ°¸ä¹…æœ‰æ•ˆ

ğŸ’ **VIPæœƒå“¡**
â€¢ æ¶ˆè²»æ»¿\$10,000è‡ªå‹•å‡ç´š
â€¢ äº«å—æ›´å¤šå°ˆå±¬å„ªæƒ 
â€¢ å°ˆå±¬å®¢æœé€šé“

éœ€è¦æˆ‘å”åŠ©ä½ è¨»å†Šæœƒå“¡å—ï¼Ÿ
''',
  };

  void sendMessage(String userMessage) {
    // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
    _messages.add(
      ChatMessage(
        content: userMessage,
        isUser: true,
        timestamp: DateTime.now(),
      ),
    );
    notifyListeners();

    // æ¨¡æ“¬AIè™•ç†æ™‚é–“
    _isLoading = true;
    notifyListeners();

    // å»¶é²å›æ‡‰ï¼Œæ¨¡æ“¬AIæ€è€ƒæ™‚é–“
    Future.delayed(const Duration(milliseconds: 1500), () {
      _generateAiResponse(userMessage);
    });
  }

  void sendImageMessage(String imagePath) {
    // æ·»åŠ ç”¨æˆ¶åœ–ç‰‡è¨Šæ¯
    _messages.add(
      ChatMessage(
        content: 'æˆ‘ä¸Šå‚³äº†ä¸€å¼µåœ–ç‰‡',
        isUser: true,
        timestamp: DateTime.now(),
        imagePath: imagePath,
      ),
    );
    notifyListeners();

    // æ¨¡æ“¬AIè™•ç†æ™‚é–“
    _isLoading = true;
    notifyListeners();

    // å»¶é²å›æ‡‰ï¼Œæ¨¡æ“¬AIåˆ†æåœ–ç‰‡æ™‚é–“
    Future.delayed(const Duration(milliseconds: 2000), () {
      _generateImageResponse(imagePath);
    });
  }

  void _generateAiResponse(String userMessage) {
    String aiResponse = _getAiResponse(userMessage);

    _messages.add(
      ChatMessage(
        content: aiResponse,
        isUser: false,
        timestamp: DateTime.now(),
      ),
    );

    _isLoading = false;
    notifyListeners();
  }

  void _generateImageResponse(String imagePath) {
    // æ¨¡æ“¬AIåˆ†æåœ–ç‰‡çš„å›æ‡‰
    final responses = [
      '''æˆ‘çœ‹åˆ°äº†ä½ ä¸Šå‚³çš„åœ–ç‰‡ï¼ğŸ“¸

é›–ç„¶æˆ‘ç„¡æ³•ç›´æ¥åˆ†æåœ–ç‰‡å…§å®¹ï¼Œä½†æˆ‘å¯ä»¥æ ¹æ“šä½ çš„æè¿°ä¾†å¹«åŠ©ä½ ï¼š

â€¢ å¦‚æœæ˜¯æ›¸ç±å°é¢ï¼Œæˆ‘å¯ä»¥å¹«ä½ æ¨è–¦é¡ä¼¼çš„æ›¸ç±
â€¢ å¦‚æœæ˜¯æ¢ç¢¼ï¼Œæˆ‘å¯ä»¥å”åŠ©ä½ æœå°‹ç›¸é—œæ›¸ç±
â€¢ å¦‚æœæ˜¯å…¶ä»–å…§å®¹ï¼Œè«‹å‘Šè¨´æˆ‘ä½ æƒ³äº†è§£ä»€éº¼

è«‹æè¿°ä¸€ä¸‹åœ–ç‰‡å…§å®¹ï¼Œæˆ‘æœƒç›¡åŠ›å¹«åŠ©ä½ ï¼''',

      '''æ„Ÿè¬ä½ åˆ†äº«çš„åœ–ç‰‡ï¼ğŸ–¼ï¸

æˆ‘æ³¨æ„åˆ°ä½ ä¸Šå‚³äº†ä¸€å¼µåœ–ç‰‡ã€‚é›–ç„¶æˆ‘ç›®å‰ç„¡æ³•ç›´æ¥è­˜åˆ¥åœ–ç‰‡å…§å®¹ï¼Œä½†æˆ‘å¯ä»¥ï¼š

â€¢ æ ¹æ“šä½ çš„æè¿°æ¨è–¦ç›¸é—œæ›¸ç±
â€¢ å”åŠ©ä½ æœå°‹ç‰¹å®šä¸»é¡Œçš„æ›¸ç±
â€¢ å›ç­”é—œæ–¼æ›¸ç±çš„å•é¡Œ

è«‹å‘Šè¨´æˆ‘åœ–ç‰‡ä¸­æ˜¯ä»€éº¼ï¼Œæˆ–è€…ä½ æƒ³äº†è§£ä»€éº¼ï¼Œæˆ‘æœƒç‚ºä½ æä¾›å¹«åŠ©ï¼''',

      '''æˆ‘çœ‹åˆ°ä½ ä¸Šå‚³äº†ä¸€å¼µåœ–ç‰‡ï¼ğŸ“·

å¾ˆæŠ±æ­‰ï¼Œæˆ‘ç›®å‰ç„¡æ³•ç›´æ¥åˆ†æåœ–ç‰‡å…§å®¹ï¼Œä½†æˆ‘å¯ä»¥ï¼š

â€¢ æ ¹æ“šä½ çš„æ–‡å­—æè¿°æä¾›æ›¸ç±æ¨è–¦
â€¢ å”åŠ©ä½ æ‰¾åˆ°æƒ³è¦çš„æ›¸ç±
â€¢ å›ç­”é—œæ–¼è³¼ç‰©å’Œæ›¸ç±çš„å•é¡Œ

è«‹ç”¨æ–‡å­—æè¿°ä¸€ä¸‹åœ–ç‰‡å…§å®¹ï¼Œæˆ–è€…å‘Šè¨´æˆ‘ä½ æƒ³äº†è§£ä»€éº¼ï¼Œæˆ‘æœƒç›¡åŠ›å¹«åŠ©ä½ ï¼''',
    ];

    final response = responses[DateTime.now().millisecond % responses.length];

    _messages.add(
      ChatMessage(content: response, isUser: false, timestamp: DateTime.now()),
    );

    _isLoading = false;
    notifyListeners();
  }

  String _getAiResponse(String userMessage) {
    final message = userMessage.toLowerCase();

    // æ ¹æ“šé—œéµå­—åŒ¹é…å›æ‡‰
    if (message.contains('æ¨è–¦') || message.contains('å»ºè­°')) {
      return _knowledgeBase['æ¨è–¦'] ?? _getDefaultResponse();
    } else if (message.contains('æ›¸ç±') || message.contains('æ›¸')) {
      return _knowledgeBase['æ›¸ç±'] ?? _getDefaultResponse();
    } else if (message.contains('åƒ¹æ ¼') ||
        message.contains('å¤šå°‘éŒ¢') ||
        message.contains('åƒ¹éŒ¢')) {
      return _knowledgeBase['åƒ¹æ ¼'] ?? _getDefaultResponse();
    } else if (message.contains('é‹è²»') ||
        message.contains('é…é€') ||
        message.contains('å¯„é€')) {
      return _knowledgeBase['é‹è²»'] ?? _getDefaultResponse();
    } else if (message.contains('æœƒå“¡') ||
        message.contains('è¨»å†Š') ||
        message.contains('ç™»å…¥')) {
      return _knowledgeBase['æœƒå“¡'] ?? _getDefaultResponse();
    } else if (message.contains('ä½ å¥½') ||
        message.contains('hi') ||
        message.contains('hello')) {
      return '''ä½ å¥½ï¼æˆ‘æ˜¯è®€å†Šç”Ÿæ´»ç¶²è·¯æ›¸åº—çš„AIæ™ºèƒ½åŠ©æ‰‹ ğŸ¤–

æˆ‘å¯ä»¥å¹«ä½ ï¼š
â€¢ æ¨è–¦é©åˆçš„æ›¸ç±
â€¢ è§£ç­”è³¼ç‰©ç›¸é—œå•é¡Œ
â€¢ æä¾›æœƒå“¡æœå‹™è³‡è¨Š
â€¢ å”åŠ©ä½ æ‰¾åˆ°æƒ³è¦çš„æ›¸ç±

æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ''';
    } else if (message.contains('è¬è¬') || message.contains('æ„Ÿè¬')) {
      return '''ä¸å®¢æ°£ï¼å¾ˆé«˜èˆˆèƒ½å¹«åŠ©åˆ°ä½  ğŸ˜Š

å¦‚æœé‚„æœ‰å…¶ä»–å•é¡Œï¼Œéš¨æ™‚éƒ½å¯ä»¥å•æˆ‘ï¼
ç¥ä½ åœ¨è®€å†Šç”Ÿæ´»æ‰¾åˆ°å¿ƒå„€çš„æ›¸ç±ï¼''';
    } else {
      return _getDefaultResponse();
    }
  }

  String _getDefaultResponse() {
    final responses = [
      '''æˆ‘ç†è§£ä½ çš„å•é¡Œï¼Œä½†å¯èƒ½éœ€è¦æ›´å¤šè³‡è¨Šä¾†å¹«åŠ©ä½ ã€‚

ä½ å¯ä»¥è©¦è©¦å•æˆ‘ï¼š
â€¢ "æ¨è–¦ä¸€äº›ç¨‹å¼è¨­è¨ˆçš„æ›¸ç±"
â€¢ "æ›¸ç±åƒ¹æ ¼æ˜¯å¤šå°‘ï¼Ÿ"
â€¢ "å¦‚ä½•è¨»å†Šæœƒå“¡ï¼Ÿ"
â€¢ "é‹è²»æ€éº¼è¨ˆç®—ï¼Ÿ"

æˆ–è€…å‘Šè¨´æˆ‘ä½ å…·é«”æƒ³äº†è§£ä»€éº¼ï¼Œæˆ‘æœƒç›¡åŠ›å¹«åŠ©ä½ ï¼''',

      '''é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„å•é¡Œï¼è®“æˆ‘ç‚ºä½ æä¾›ä¸€äº›å»ºè­°ï¼š

ğŸ“š ä½ å¯ä»¥ï¼š
1. ç€è¦½é¦–é çš„æ¨è–¦åˆ†é¡
2. ä½¿ç”¨æœå°‹åŠŸèƒ½æ‰¾æ›¸
3. æŸ¥çœ‹æš¢éŠ·æ’è¡Œæ¦œ
4. é—œæ³¨æ–°æ›¸ä¸Šæ¶

éœ€è¦æˆ‘å¹«ä½ æ¨è–¦ç‰¹å®šé¡å‹çš„æ›¸ç±å—ï¼Ÿ''',

      '''æˆ‘é‚„åœ¨å­¸ç¿’ä¸­ï¼Œå¯èƒ½ç„¡æ³•å®Œå…¨ç†è§£ä½ çš„å•é¡Œã€‚

ä¸éæˆ‘å¯ä»¥å¹«ä½ ï¼š
â€¢ æ¨è–¦æ›¸ç±
â€¢ è§£ç­”è³¼ç‰©å•é¡Œ
â€¢ æä¾›æœå‹™è³‡è¨Š

è«‹è©¦è©¦ç”¨æ›´ç°¡å–®çš„æ–¹å¼å•æˆ‘ï¼Œæˆ–è€…å‘Šè¨´æˆ‘ä½ æƒ³äº†è§£ä»€éº¼ï¼''',
    ];

    return responses[DateTime.now().millisecond % responses.length];
  }

  void clearChat() {
    _messages.clear();
    _isLoading = false;
    notifyListeners();
  }

  // æ·»åŠ é è¨­æ­¡è¿è¨Šæ¯
  void addWelcomeMessage() {
    if (_messages.isEmpty) {
      _messages.add(
        ChatMessage(
          content: '''æ­¡è¿ä¾†åˆ°è®€å†Šç”Ÿæ´»ç¶²è·¯æ›¸åº—ï¼æˆ‘æ˜¯ä½ çš„AIæ™ºèƒ½åŠ©æ‰‹ ğŸ¤–

æˆ‘å¯ä»¥å¹«ä½ ï¼š
â€¢ ğŸ“š æ¨è–¦é©åˆçš„æ›¸ç±
â€¢ ğŸ’° è§£ç­”åƒ¹æ ¼å’Œå„ªæƒ å•é¡Œ
â€¢ ğŸšš æä¾›é…é€è³‡è¨Š
â€¢ ğŸ‘¤ å”åŠ©æœƒå“¡æœå‹™
â€¢ ğŸ” å¹«ä½ æ‰¾åˆ°æƒ³è¦çš„æ›¸ç±

æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ''',
          isUser: false,
          timestamp: DateTime.now(),
        ),
      );
      notifyListeners();
    }
  }
}
