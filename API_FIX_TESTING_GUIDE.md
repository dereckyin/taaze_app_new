# API修復測試指南

## 問題分析

從日誌中發現的問題：
```
flutter: [API] 2025-09-20T00:12:51.938759: API Response: 422
flutter: [API] 2025-09-20T00:12:51.938969: Response Body: {"detail":"僅支援 jpeg/png/webp 圖片"}
```

**根本原因**：API要求正確的圖片MIME類型，但我們之前沒有正確設置Content-Type。

## 修復內容

### 1. 正確設置圖片MIME類型
- 根據文件擴展名自動檢測圖片格式
- 支持 jpg/jpeg、png、webp 格式
- 正確設置 Content-Type header

### 2. 改進錯誤處理
- 解析API返回的詳細錯誤信息
- 提供更友好的錯誤提示

## 測試步驟

### 步驟1：準備測試圖片
在模擬器中添加不同格式的圖片：
1. **JPEG圖片**：.jpg 或 .jpeg 格式
2. **PNG圖片**：.png 格式
3. **WebP圖片**：.webp 格式（如果有的話）

### 步驟2：測試AI上架精靈
1. 進入AI智能助手
2. 點擊「AI上架精靈」
3. 選擇「從相簿選擇」
4. 選擇不同格式的圖片進行測試

### 步驟3：觀察日誌輸出
查看控制台日誌，應該看到：
```
flutter: [API] API Request: POST https://api.taaze.tw/api/v1/vision/identify-book
flutter: [API] API Response: 200 (成功) 或 422 (格式錯誤)
```

### 步驟4：測試錯誤處理
如果API仍然返回422錯誤，現在會顯示更詳細的錯誤信息：
- 之前：`書籍識別API返回錯誤狀態碼: 422`
- 現在：`僅支援 jpeg/png/webp 圖片`

## 預期結果

### 成功情況
- API返回200狀態碼
- 顯示識別結果或使用模擬數據
- 用戶可以正常選擇和編輯書籍

### 失敗情況
- 顯示具體的錯誤信息
- 自動回退到模擬數據
- 用戶仍然可以測試完整流程

## 調試命令

### 查看實時日誌
```bash
flutter logs
```

### 熱重載
在運行中的應用按 `r` 鍵

### 熱重啟
在運行中的應用按 `R` 鍵

## 常見問題

### 1. 圖片格式問題
- 確保圖片是 jpg、png 或 webp 格式
- 避免使用其他格式如 gif、bmp 等

### 2. 圖片大小問題
- 確保圖片大小適中（建議小於10MB）
- 過大的圖片可能導致上傳失敗

### 3. 網絡問題
- 檢查網絡連接
- API調用失敗時會自動使用模擬數據

## 測試檢查清單

- [ ] 應用成功啟動
- [ ] 可以選擇不同格式的圖片
- [ ] API調用返回正確的狀態碼
- [ ] 錯誤信息更加詳細和友好
- [ ] 模擬數據作為備用方案正常工作
- [ ] 完整的用戶流程可以正常執行

## 下一步

如果修復成功，您可以：
1. 測試真實的書籍照片
2. 驗證識別結果的準確性
3. 測試批量上傳功能
4. 優化用戶體驗
